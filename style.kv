#:kivy 1.9.0
#:import colors kivymd.color_definitions
#:import Animation kivy.animation.Animation

<LimitTextInput>:
    limit: 100
    font_size: '15sp'

<NamingDialogContent>:
    orientation: "vertical"
    size_hint: 1, None
    height: textfield.minimum_height
    LimitTextInput:
        id: textfield
        hint_text: "Nomeie a nota"

<RenamingDialogContent>:
    orientation: "vertical"
    size_hint: 1, None
    height: textfield.minimum_height
    LimitTextInput:
        id: textfield
        hint_text: "Renomeie a nota"
        
<TabTextField>:
    use_bubble: True
    hint_text: "Digite aqui"
    font_size: app.font_size
    line_anim: False
    size_hint: 1, None
    multiline: True
    padding_x: [dp(10)]
    padding_y: [dp(10)]
    background_color: 0, 0, 0, 0
    foreground_color: 1, 1, 1, 1
    scroll_distance: dp(1)

<LateralMenuBase@MDBoxLayout>:
    id: _lm
    orientation: 'vertical'
    size_hint: .8, 1
    pos_hint: {'x': -2, 'top': 1}
    bg_opacity: 0
    open_anim: Animation(pos_hint={'x': 0}, bg_opacity=0.75, duration=0.1)
    close_anim: Animation(pos_hint={'x': -2}, bg_opacity=0, duration=0.1)
    open: lambda: self.open_anim.start(self)
    close: lambda: self.close_anim.start(self)
    on_touch_down: self.close() if not self.collide_point(*args[1].pos) else 0
    canvas.before:
        Rectangle:
            pos: self.pos
            size: self.size
        Color:
            rgba: 0, 0, 0, self.bg_opacity
        Rectangle:
            pos: 0, 0
            size: self.width*1.25, self.height

<TextButton@MDRectangleFlatButton>:
    line_color: 1, 1, 1, 0
    theme_text_color: "Custom"
    text_color: 1, 1, 1, 1
    halign: 'left'
    text: "Background"            
    icon: "selection-multiple"
    size_hint: 1, None
    height: dp(60)
    font_size: '20sp'
    on_press:
        app.switch_note(self.text)
        app.root.lm.close()

<ItemButton@TextButton>:
    selected: False
    line_color: app.theme_cls.accent_color if self.selected else (1, 1, 1, 0)
    
<NoteButton@TextButton>:
    selected: False
    font_size: '15sp'
    halign: 'center'
    canvas.after:
        Color:
            rgba: app.theme_cls.accent_color if self.selected else (0, 0, 0, 0)
        Line:
            width: dp(1.5)
            points: self.x, self.y, self.x + self.width, self.y

<LateralMenu@LateralMenuBase>:
    rv: _rv
    md_bg_color: app.theme_cls.primary_dark
    radius: [0, 25, 0, 0]
    RelativeLayout:
        size_hint: .94, .1
        pos_hint: {"center_x": .5}
        MDTextField:
            id: _search_box
            size_hint: 1, None
            pos_hint: {"center_y": .5}
            color_mode: 'custom'
            line_color_focus: .8, .8, .8, 1
            text_color_normal: .8, .8, .8, 1
            text_color_focus: .8, .8, .8, 1
            font_size: "18sp"
            hint_text: "Pesquisar notas"
            hint_text_color_focus: .8, .8, .8, 0.5
            hint_text_color_normal: .8, .8, .8, 0.5
            on_text:
                strings = list(filter(lambda text: self.text.lower() in text.lower(), app.get_files_order()))
                _rv.data = [{'text': string} for string in strings]
        MDIconButton:
            pos_hint: {'right': 1, 'center_y': .5}
            icon: "magnify"
            on_press:
                _search_box.text += ""
    RecycleView:
        id: _rv
        viewclass: 'ItemButton'
        size_hint: 1, .66
        pos_hint: {'center_x': .5, 'top': .7}
        RecycleBoxLayout:
            orientation: 'vertical'
            default_size: None, dp(56)
            default_size_hint: 1, None
            size_hint_y: None
            height: self.minimum_height
            spacing: dp(5)
            padding: dp(2)
    MDBoxLayout:
        md_bg_color: .2, .2, .2, 1
        radius: [0, 25, 0, 0]
        size_hint: 1, .15
        pos_hint: {'top': .9}
        padding: dp(10)
        orientation: 'vertical'
        MDBoxLayout:
            size_hint: 1, .5
            MDIconButton:
                icon: 'minus'
                on_press: app.change_font_size(False)
            Label:
                text: f'Fonte: {app.font_size}'.replace('sp', '')
            MDIconButton:
                icon: 'plus'
                on_press: app.change_font_size()
        MDTextButton:
            text: 'Sobre'
            size_hint: 1, .5
            font_size: '17.5sp'
            haling: 'center'
            on_press: app.link()
    MDLabel:
        md_bg_color: .2, .2, .2, 1
        text: 'By Felifelps'
        font_size: '13sp'
        size_hint: 1, .04
        halign: 'center'

<Bar@MDBoxLayout>:
    md_bg_color: app.theme_cls.primary_color
    padding: dp(10)

<BottomBar@Bar>:
    radius: [15, 15, 0, 0]
    MDIconButton:
        icon: 'undo'
        size_hint_x: .25 
        on_press: app.actionbarbutton(self)
    MDIconButton:
        icon: 'redo'
        size_hint_x: .25 
        on_press: app.actionbarbutton(self)
    MDIconButton:
        icon: "music-accidental-flat"
        size_hint_x: .25 
        on_press: app.actionbarbutton(self)
    MDIconButton:
        icon: "music-accidental-sharp"
        size_hint_x: .25 
        on_press: app.actionbarbutton(self)

<TopBar@Bar>:
    md_bg_color: app.theme_cls.primary_color
    padding: dp(10)
    MDLabel:
        text: '[b]CifraNote[/b]'
        font_size: '27.5sp'
        markup: True
    MDIconButton:
        icon: 'plus'
        on_press: app.actionbarbutton(self)
    MDIconButton:
        icon: 'form-textbox'
        on_press: app.actionbarbutton(self)
    MDIconButton:
        icon: 'trash-can-outline'
        on_press: app.actionbarbutton(self)
    MDIconButton:
        icon: 'menu'
        on_press: app.actionbarbutton(self)

<NotesCarousel@RecycleView>:
    canvas.before:
        Color:
            rgba: app.theme_cls.primary_color 
        Rectangle:
            size: self.size
            pos: self.x, self.y
    viewclass: 'NoteButton'
    RecycleBoxLayout:
        default_size: dp(56), None
        default_size_hint: None, 1
        size_hint_x: None
        width: self.minimum_width
        spacing: dp(5)
        padding: dp(2)
                
MDScreen:
    id: _screen
    lm: _lm
    notes: _notes
    textfield: _textfield
    textfield_scroll: _textfield_scroll
    bottombar: _bottombar
    MDFloatLayout:
        TopBar:
            size_hint: 1, .1
            pos_hint: {'center_x': .5, 'top': 1}
        RelativeLayout:
            size_hint: 1, .8
            pos_hint: {'center_x': .5, 'top': .9}
            NotesCarousel:
                id: _notes
                selected: app.conf['options']['last_opened']
                size_hint: 1, .1
                pos_hint: {'center_x': .5, 'top': 1}
                on_selected:
                    _textfield_scroll.scroll_y = 1
                    _textfield.text = app.file_data[self.selected]
            ScrollView:
                id: _textfield_scroll
                size_hint: 1, .9
                pos_hint: {"center_x": .5, "y": 0}
                scroll_distance: dp(1)
                TabTextField:
                    id: _textfield
                    input_type: 'text'
                    keyboard_suggestions: True
                    on_focus: app.on_textinput_focus()
                    size_hint: 1, None
                    height: _screen.height * 0.825 if self.minimum_height < _screen.height * 0.825 else self.minimum_height + _screen.height*0.6
        BottomBar:
            id: _bottombar
            pos_hint: {'center_x': .5}
            y: 0
            size_hint: 1, .1
    LateralMenu:
        id: _lm